(function(){var e;var b=function(f,g){return function(){return f.apply(g,arguments)}},a=Object.prototype.hasOwnProperty,d=function(i,g){for(var f in g){if(a.call(g,f)){i[f]=g[f]}}function h(){this.constructor=i}h.prototype=g.prototype;i.prototype=new h;i.__super__=g.prototype;return i},c=Array.prototype.indexOf||function(h){for(var g=0,f=this.length;g<f;g++){if(this[g]===h){return g}}return -1};e=jQuery;Annotator.Plugins.User=(function(){d(f,Delegator);f.prototype.events={beforeAnnotationCreated:"addUserToAnnotation",annotationViewerShown:"updateViewer"};f.prototype.options={userId:function(g){return g},userString:function(g){return g},userGroups:function(g){return["public"]}};function f(h,g){this.updateViewer=b(this.updateViewer,this);this.addUserToAnnotation=b(this.addUserToAnnotation,this);f.__super__.constructor.apply(this,arguments);this.addEvents()}f.prototype.setUser=function(g){return this.user=g};f.prototype.addUserToAnnotation=function(h,g){if(this.user&&g){return g.user=this.user}};f.prototype.authorise=function(l,k){var o,i,h,r,m,q,n,j;if(h=k.permissions){if(!l||!h[l]){return true}else{if(n="user:"+(this.options.userId(this.user)),c.call(h[l],n)>=0){return true}else{if(i=this.options.userGroups(this.user)){for(m=0,q=i.length;m<q;m++){o=i[m];if(j="group:"+o,c.call(h[l],j)>=0){return true}}return false}}}}else{if(r=k.user){if(this.user&&this.options.userId(this.user)===r){return true}else{return false}}else{return true}}};f.prototype.updateViewer=function(o,s,l){var p,q,m,n,h,k,r,j,g;h=e(s).find(".annotator-ann");g=[];for(k=0,j=h.length;(0<=j?k<j:k>j);(0<=j?k+=1:k-=1)){p=h.eq(k).find(".annotator-ann-controls");m=h.eq(k).find(".annotator-ann-text");if(r=l[k].user){e("<div class='annotator-ann-user'>"+(this.options.userString(r))+"</div>").insertAfter(m)}g.push("permissions" in l[k]?(p.show(),n=p.find(".edit"),q=p.find(".delete"),this.authorise("update",l[k])?n.show():n.hide(),this.authorise("delete",l[k])?q.show():q.hide()):"user" in l[k]?this.authorise(null,l[k])?p.children().andSelf().show():p.hide():p.children().andSelf().show())}return g};return f})()}).call(this);