(function(){var i,d,b,n,h,k,f,e,o,a,g;var j=Array.prototype.slice,l=function(p,q){return function(){return p.apply(q,arguments)}},m=Object.prototype.hasOwnProperty,c=function(s,q){for(var p in q){if(m.call(q,p)){s[p]=q[p]}}function r(){this.constructor=s}r.prototype=q.prototype;s.prototype=new r;s.__super__=q.prototype;return s};h=["log","debug","info","warn","exception","assert","dir","dirxml","trace","group","groupEnd","groupCollapsed","time","timeEnd","profile","profileEnd","count","clear","table","error","notifyFirebug","firebug","userObjects"];if(typeof console!="undefined"&&console!==null){if(!(console.group!=null)){console.group=function(p){return console.log("GROUP: ",p)}}if(!(console.groupCollapsed!=null)){console.groupCollapsed=console.group}for(f=0,o=h.length;f<o;f++){n=h[f];if(!(console[n]!=null)){console[n]=function(){return console.log("Not implemented: console."+name)}}}}else{this.console={};for(e=0,a=h.length;e<a;e++){n=h[e];this.console[n]=function(){}}this.console.error=function(){var p;p=1<=arguments.length?j.call(arguments,0):[];return alert("ERROR: "+(p.join(", ")))};this.console.warn=function(){var p;p=1<=arguments.length?j.call(arguments,0):[];return alert("WARNING: "+(p.join(", ")))}}if(!(typeof jQuery!="undefined"&&jQuery!==null?(g=jQuery.fn)!=null?g.jquery:void 0:void 0)){console.error("Annotator requires jQuery: have you included lib/vendor/jquery.js?")}if(!(JSON&&JSON.parse&&JSON.stringify)){console.error("Annotator requires a JSON implementation: have you included lib/vendor/json2.js?")}i=jQuery;b=(function(){p.prototype.events={};function p(r,q){this.options=i.extend(this.options,q);this.element=r}p.prototype.addEvents=function(){var s,w,v,q,u,t,x,r;t=this.events;r=[];for(v in t){w=t[v];x=v.split(" "),q=2<=x.length?j.call(x,0,u=x.length-1):(u=0,[]),s=x[u++];r.push(this.addEvent(q.join(" "),s,w))}return r};p.prototype.addEvent=function(q,s,t){var u,r;u=l(function(){return this[t].apply(this,arguments)},this);r=typeof q==="string"&&q.replace(/\s+/g,"")==="";if(r){q=this.element}if(typeof q==="string"){return i(this.element).delegate(q,s,u)}else{return i(q).bind(s,u)}};return p})();this.Delegator=b;i.plugin=function(q,p){return i.fn[q]=function(s){var r;r=Array.prototype.slice.call(arguments,1);return this.each(function(){var t;t=i.data(this,q);if(t){return s&&t[s].apply(t,r)}else{t=new p(this,s);return i.data(this,q,t)}})}};i=jQuery;Array.prototype.flatten=function(){var p;p=function(r){var s,u,t,q;u=[];for(t=0,q=r.length;t<q;t++){s=r[t];u=u.concat(s&&i.isArray(s)?p(s):s)}return u};return p(this)};i.fn.textNodes=function(){var p;p=function(s){var v,u,r,t,q;if(s&&s.nodeType!==3){t=i(s).contents().get();q=[];for(u=0,r=t.length;u<r;u++){v=t[u];q.push(p(v))}return q}else{return s}};return this.map(function(){return p(this).flatten()})};i.fn.xpath=function(p){var q;q=this.map(function(){var s,r,t;t="";s=this;while(s&&s.nodeType===1&&s!==p){r=i(s.parentNode).children(s.tagName).index(s)+1;r=r>1?"["+r+"]":"";t="/"+s.tagName.toLowerCase()+r+t;s=s.parentNode}return t});return q.get()};i=jQuery;this.Range={};Range.sniff=function(p){if(p.commonAncestorContainer!=null){return new Range.BrowserRange(p)}else{if(p.start&&typeof p.start==="string"){return new Range.SerializedRange(p)}else{if(p.start&&typeof p.start==="object"){return new Range.NormalizedRange(p)}else{console.error("Couldn't not sniff range type");return false}}}};Range.BrowserRange=(function(){function p(q){this.commonAncestorContainer=q.commonAncestorContainer;this.startContainer=q.startContainer;this.startOffset=q.startOffset;this.endContainer=q.endContainer;this.endOffset=q.endOffset}p.prototype.normalize=function(y){var x,t,A,u,s,q,v,z,w;if(this.tainted){console.error("You may only call normalize() once on a BrowserRange!");return false}else{this.tainted=true}q={};A={};w=["start","end"];for(v=0,z=w.length;v<z;v++){s=w[v];t=this[s+"Container"];u=this[s+"Offset"];if(t.nodeType===1){x=t.childNodes[u];t=x||t.childNodes[u-1];while(t.nodeType!==3){t=t.firstChild}u=x?0:t.nodeValue.length}q[s]=t;q[s+"Offset"]=u}A.start=q.startOffset>0?q.start.splitText(q.startOffset):q.start;if(q.start===q.end){if((q.endOffset-q.startOffset)<A.start.nodeValue.length){A.start.splitText(q.endOffset-q.startOffset)}A.end=A.start}else{if(q.endOffset<q.end.nodeValue.length){q.end.splitText(q.endOffset)}A.end=q.end}A.commonAncestor=this.commonAncestorContainer;while(A.commonAncestor.nodeType!==1){A.commonAncestor=A.commonAncestor.parentNode}return new Range.NormalizedRange(A)};p.prototype.serialize=function(q,r){return this.normalize(q).serialize(q,r)};return p})();Range.NormalizedRange=(function(){function p(q){this.commonAncestor=q.commonAncestor;this.start=q.start;this.end=q.end}p.prototype.normalize=function(q){return this};p.prototype.serialize=function(s,t){var r,q,u;q=function(y,x){var w,v,A,E,C,B,z,D;if(t){E=i(y).parents(":not("+t+")").eq(0)}else{E=i(y).parent()}B=E.xpath(s)[0];C=E.textNodes();v=C.slice(0,C.index(y));A=0;for(z=0,D=v.length;z<D;z++){w=v[z];A+=w.nodeValue.length}if(x){return[B,A+y.nodeValue.length]}else{return[B,A]}};u=q(this.start);r=q(this.end,true);return new Range.SerializedRange({start:u[0],end:r[0],startOffset:u[1],endOffset:r[1]})};return p})();Range.SerializedRange=(function(){function p(q){this.start=q.start;this.startOffset=q.startOffset;this.end=q.end;this.endOffset=q.endOffset}p.prototype.normalize=function(D){var G,z,x,F,v,B,C,E,A,w,u,s,q,H,I,y,t,r;B=function(J){return document.evaluate(J,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue};E=i(D).xpath()[0];w=this.start.split("/");x=this.end.split("/");z=[];A={};for(F=0,y=w.length;(0<=y?F<y:F>y);(0<=y?F+=1:F-=1)){if(w[F]===x[F]){z.push(w[F])}else{break}}G=E+z.join("/");A.commonAncestorContainer=B(G);if(!A.commonAncestorContainer){console.error("Error deserializing range: can't find XPath '"+G+"'. Is this the right document?")}t=["start","end"];for(s=0,H=t.length;s<H;s++){C=t[s];v=0;r=i(B(E+this[C])).textNodes();for(q=0,I=r.length;q<I;q++){u=r[q];if(v+u.nodeValue.length>=this[C+"Offset"]){A[C+"Container"]=u;A[C+"Offset"]=this[C+"Offset"]-v;break}else{v+=u.nodeValue.length}}}return new Range.BrowserRange(A).normalize(D)};p.prototype.serialize=function(q,r){return this.normalize(q).serialize(q,r)};p.prototype.toObject=function(){return{start:this.start,startOffset:this.startOffset,end:this.end,endOffset:this.endOffset}};return p})();i=jQuery;if(!(JSON&&JSON.parse&&JSON.stringify)){console.error("Annotator requires JSON support: have you included lib/vendor/json2.js?")}k={getGlobal:function(){return(function(){return this})()},mousePosition:function(p,r){var q;q=i(r).offset();return{top:p.pageY-q.top,left:p.pageX-q.left}}};d=(function(){c(p,b);p.prototype.events={".annotator-adder mousedown":"adderMousedown",".annotator-hl mouseover":"highlightMouseover",".annotator-hl mouseout":"startViewerHideTimer",".annotator-viewer mouseover":"clearViewerHideTimer",".annotator-viewer mouseout":"startViewerHideTimer",".annotator-editor textarea keydown":"processEditorKeypress",".annotator-editor form submit":"submitEditor",".annotator-editor button.annotator-editor-save click":"submitEditor",".annotator-editor button.annotator-editor-cancel click":"hideEditor",".annotator-ann-controls .edit click":"controlEditClick",".annotator-ann-controls .del click":"controlDeleteClick",mouseup:"checkForEndSelection",mousedown:"checkForStartSelection"};p.prototype.dom={adder:"<div class='annotator-adder'><a href='#'></a></div>",editor:"<div class='annotator-editor'>\n  <form>\n    <textarea></textarea>\n    <div class='annotator-editor-controls'>\n      <button type='submit' class='annotator-editor-save'>Save</button>\n      <button type='submit' class='annotator-editor-cancel'>Cancel</button>\n    </div>\n  <form>\n</div>",hl:"<span class='annotator-hl'></span>",viewer:"<div class='annotator-viewer'></div>"};p.prototype.options={};function p(s,r){this.controlDeleteClick=l(this.controlDeleteClick,this);this.controlEditClick=l(this.controlEditClick,this);this.adderMousedown=l(this.adderMousedown,this);this.highlightMouseover=l(this.highlightMouseover,this);this.clearViewerHideTimer=l(this.clearViewerHideTimer,this);this.startViewerHideTimer=l(this.startViewerHideTimer,this);this.showViewer=l(this.showViewer,this);this.submitEditor=l(this.submitEditor,this);this.processEditorKeypress=l(this.processEditorKeypress,this);this.hideEditor=l(this.hideEditor,this);this.showEditor=l(this.showEditor,this);this.checkForEndSelection=l(this.checkForEndSelection,this);this.checkForStartSelection=l(this.checkForStartSelection,this);var q,u,t;p.__super__.constructor.apply(this,arguments);this.plugins={};this.wrapper=i("<div></div>").addClass("annotator-wrapper");i(this.element).wrapInner(this.wrapper);this.wrapper=i(this.element).contents().get(0);t=this.dom;for(q in t){u=t[q];this.dom[q]=i(u).hide().appendTo(this.wrapper)}this.addEvents()}p.prototype.checkForStartSelection=function(q){this.startViewerHideTimer();return this.mouseIsDown=true};p.prototype.checkForEndSelection=function(t){var r,q;this.mouseIsDown=false;if(this.ignoreMouseup){return}this.getSelection();r=this.selection;q=(r!=null?r.rangeCount:void 0)>0&&!r.isCollapsed;if(t&&q){return this.dom.adder.css(k.mousePosition(t,this.wrapper)).show()}else{return this.dom.adder.hide()}};p.prototype.getSelection=function(){var q;this.selection=k.getGlobal().getSelection();return this.selectedRanges=(function(){var s,r;r=[];for(q=0,s=this.selection.rangeCount;(0<=s?q<s:q>s);(0<=s?q+=1:q-=1)){r.push(this.selection.getRangeAt(q))}return r}).call(this)};p.prototype.createAnnotation=function(q,u){var s,t,w,x,v;if(u==null){u=true}s=q;s||(s={});s.ranges||(s.ranges=this.selectedRanges);s.highlights||(s.highlights=[]);s.ranges=(function(){var A,y,z,r;z=s.ranges;r=[];for(A=0,y=z.length;A<y;A++){w=z[A];v=Range.sniff(w);t=v.normalize(this.wrapper);r.push(x=t.serialize(this.wrapper,".annotator-hl"))}return r}).call(this);s.highlights=this.highlightRange(t);i(s.highlights).data("annotation",s);if(u){i(this.element).trigger("beforeAnnotationCreated",[s]);i(this.element).trigger("annotationCreated",[s])}return s};p.prototype.deleteAnnotation=function(q){var s,u,r,t;t=q.highlights;for(u=0,r=t.length;u<r;u++){s=t[u];i(s).replaceWith(i(s)[0].childNodes)}return i(this.element).trigger("annotationDeleted",[q])};p.prototype.updateAnnotation=function(q,r){i.extend(q,r);i(this.element).trigger("beforeAnnotationUpdated",[q]);return i(this.element).trigger("annotationUpdated",[q])};p.prototype.loadAnnotations=function(s){var q,r;r=[];q=l(function(v){var x,u,w,t;u=v.splice(0,10);for(w=0,t=u.length;w<t;w++){x=u[w];r.push(this.createAnnotation(x,false))}if(v.length>0){return setTimeout((function(){return q(v)}),100)}},this);return q(s)};p.prototype.dumpAnnotations=function(){if(this.plugins.Store){return this.plugins.Store.dumpAnnotations()}else{return console.warn("Can't dump annotations without Store plugin.")}};p.prototype.highlightRange=function(s){var q,r,u,x,t,w,v;t=i(s.commonAncestor).textNodes();v=[t.index(s.start),t.index(s.end)],x=v[0],r=v[1];t=t.slice(x,(r+1)||9000000000);return q=(function(){var A,z,y;y=[];for(A=0,z=t.length;A<z;A++){u=t[A];w=this.dom.hl.clone().show();y.push(i(u).wrap(w).parent().get(0))}return y}).call(this)};p.prototype.addPlugin=function(s,r){var q,t;if(this.plugins[s]){console.error("You cannot have more than one instance of any plugin.")}else{q=p.Plugins[s];if(typeof q==="function"){this.plugins[s]=new q(this.element,r);this.plugins[s].annotator=this;if(typeof(t=this.plugins[s]).pluginInit==="function"){t.pluginInit()}}else{console.error("Could not load "+s+" plugin. Have you included the appropriate <script> tag?")}}return this};p.prototype.showEditor=function(r,q){if(q){this.dom.editor.data("annotation",q);this.dom.editor.find("textarea").val(q.text)}this.dom.editor.css(k.mousePosition(r,this.wrapper)).show().find("textarea").focus();return i(this.element).trigger("annotationEditorShown",[this.dom.editor,q])};p.prototype.hideEditor=function(q){if(q!=null){q.preventDefault()}this.dom.editor.data("annotation",null).hide().find("textarea").val("");i(this.element).trigger("annotationEditorHidden",[this.dom.editor]);return this.ignoreMouseup=false};p.prototype.processEditorKeypress=function(q){if(q.keyCode===27){return this.hideEditor(q)}else{if(q.keyCode===13&&!q.shiftKey){return this.submitEditor(q)}}};p.prototype.submitEditor=function(t){var q,s,r;if(t!=null){t.preventDefault()}r=this.dom.editor.find("textarea");q=this.dom.editor.data("annotation");if(!q){s=true;q={}}i(this.element).trigger("annotationEditorSubmit",[this.dom.editor,q]);if(s){q.text=r.val();this.createAnnotation(q)}else{this.updateAnnotation(q,{text:r.val()})}return this.hideEditor()};p.prototype.showViewer=function(v,u){var s,r,w,t,q;r='<span class="annotator-ann-controls">\n  <a href="#" class="edit" alt="Edit" title="Edit this annotation">Edit</a>\n  <a href="#" class="del" alt="X" title="Delete this annotation">Delete</a>\n</span>';w=this.dom.viewer.clone().empty();for(t=0,q=u.length;t<q;t++){s=u[t];i("<div class='annotator-ann'>\n  "+r+"\n  <div class='annotator-ann-text'>\n    <p>"+s.text+"</p>\n  </div>\n</div>").appendTo(w).data("annotation",s)}w.css(k.mousePosition(v,this.wrapper)).replaceAll(this.dom.viewer).show();i(this.element).trigger("annotationViewerShown",[w.get(0),u]);return this.dom.viewer=w};p.prototype.startViewerHideTimer=function(q){if(!this.viewerHideTimer){return this.viewerHideTimer=setTimeout((function(r){return r.dom.viewer.hide()}),250,this)}};p.prototype.clearViewerHideTimer=function(){clearTimeout(this.viewerHideTimer);return this.viewerHideTimer=false};p.prototype.highlightMouseover=function(r){var q;this.clearViewerHideTimer();if(this.mouseIsDown){return false}q=i(r.target).parents(".annotator-hl").andSelf().map(function(){return i(this).data("annotation")});return this.showViewer(r,q)};p.prototype.adderMousedown=function(q){if(q!=null){q.preventDefault()}this.ignoreMouseup=true;this.dom.adder.hide();return this.showEditor(q)};p.prototype.controlEditClick=function(r){var q,s,t;q=i(r.target).parents(".annotator-ann");s=i(this.dom.viewer).offset();t={pageY:s.top,pageX:s.left};this.dom.viewer.hide();this.showEditor(t,q.data("annotation"));return false};p.prototype.controlDeleteClick=function(r){var q;q=i(r.target).parents(".annotator-ann");this.deleteAnnotation(q.data("annotation"));q.remove();if(!this.dom.viewer.is(":parent")){this.dom.viewer.hide()}return false};return p})();d.Plugins={};i.plugin("annotator",d);this.Annotator=d}).call(this);